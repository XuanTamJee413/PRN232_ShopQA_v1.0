@{
    ViewData["Title"] = "Products";
}
<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Shop</h4>
                    <div class="breadcrumb__links">
                        <a href="/Home">Home</a>
                        <span>Shop</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="shop spad">
    <div class="container">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="shop__sidebar">
                    <!-- Search -->
                    <div class="shop__sidebar__search">
                        <input type="text" id="searchInput" placeholder="Search...">
                        <button onclick="loadProducts()"><span class="icon_search"></span></button>
                    </div>

                    <!-- Filters -->
                    <div class="shop__sidebar__accordion">
                        <div class="accordion" id="accordionExample">
                            <!-- Categories -->
                            <div class="card">
                                <div class="card-heading">
                                    <a data-toggle="collapse" data-target="#collapseOne">Categories</a>
                                </div>
                                <div id="collapseOne" class="collapse show" data-parent="#accordionExample">
                                    <div class="card-body">
                                        <ul class="nice-scroll" id="categoryList">
                                            <li>Đang tải danh mục...</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Brands -->
                            <div class="card">
                                <div class="card-heading">
                                    <a data-toggle="collapse" data-target="#collapseTwo">Branding</a>
                                </div>
                                <div id="collapseTwo" class="collapse show" data-parent="#accordionExample">
                                    <div class="card-body">
                                        <ul class="nice-scroll" id="brandList">
                                            <li>Đang tải thương hiệu...</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Grid -->
            <div class="col-lg-9">
                <div class="shop__product__option">
                    <div class="row">
                        <div class="col-12">
                            <p id="productCountText">Đang tải...</p>
                        </div>
                    </div>
                </div>

                <div class="row" id="productList">
                    <div class="col-12">Đang tải sản phẩm...</div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    let selectedCategory = "";
    let selectedBrand = "";
    let cachedCategories = [];
    let cachedBrands = [];

    async function fetchData(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        return data.value;
    }

    async function loadCategories() {
        if (cachedCategories.length === 0) {
            cachedCategories = await fetchData("https://localhost:7101/odata/Category");
        }
        renderCategories();
    }

    async function loadBrands() {
        if (cachedBrands.length === 0) {
            cachedBrands = await fetchData("https://localhost:7101/odata/Brand");
        }
        renderBrands();
    }

    function renderCategories() {
        const list = document.getElementById("categoryList");
        list.innerHTML =
            `<li><a href="#" onclick="setCategory(''); return false;" style="${selectedCategory === '' ? 'color:#fff;background:#007bff;font-weight:bold;border-radius:4px;' : ''}">Tất cả</a></li>` +
            cachedCategories.map(c =>
                `<li><a href="#" onclick="setCategory(${c.Id}); return false;" style="${selectedCategory === c.Id ? 'color:#000;background:#f2f2f2;font-weight:bold;border-radius:4px;' : ''}">${c.Name}</a></li>`
            ).join('');
    }


    function renderBrands() {
        const list = document.getElementById("brandList");
        list.innerHTML =
            `<li><a href="#" onclick="setBrand(''); return false;" style="${selectedBrand === '' ? 'color:#fff;background:#007bff;font-weight:bold;border-radius:4px;' : ''}">Tất cả</a></li>` +
            cachedBrands.map(b =>
                `<li><a href="#" onclick="setBrand(${b.Id}); return false;" style="${selectedBrand === b.Id ? 'color:#000;background:#f2f2f2;font-weight:bold;border-radius:4px;' : ''}">${b.Name}</a></li>`
            ).join('');
    }


    function setCategory(id) {
        selectedCategory = id;
        renderCategories();
        loadProducts();   
    }

    function setBrand(id) {
        selectedBrand = id;
        renderBrands(); 
        loadProducts();
    }

    async function loadProducts() {
        const search = document.getElementById("searchInput").value.toLowerCase();
        let filters = [];
        if (selectedCategory) filters.push(`CategoryId eq ${selectedCategory}`);
        if (selectedBrand) filters.push(`BrandId eq ${selectedBrand}`);
        if (search) filters.push(`contains(tolower(Name), '${search}')`);

        const filterQuery = filters.length ? `&$filter=${filters.join(' and ')}` : '';
        const url = `https://localhost:7101/odata/Product?$expand=Variants,Category,Brand${filterQuery}`;
        const container = document.getElementById("productList");
        const countText = document.getElementById("productCountText");

        try {
            const products = await fetchData(url);
            countText.innerText = `Đã tìm thấy ${products.length} sản phẩm`;
            if (products.length === 0) {
                container.innerHTML = `<div class="col-12"><h5>Không tìm thấy sản phẩm nào.</h5></div>`;
                return;
            }

            container.innerHTML = products.map(p => `
                <div class="col-lg-4 col-md-6 col-sm-6">
                    <div class="product__item">
                        <div class="product__item__pic set-bg">
                            <img src="${p.ImageUrl || '/img/product/Default_product.jpg'}"
                                 onerror="this.onerror=null;this.src='/img/product/Default_product.jpg';"
                                 alt="Product Image">
                            <ul class="product__hover">
                                <li><a href="#"><img src="/img/icon/cart.png"> <span>+ Cart</span></a></li>
                                <li><a href="#"><img src="/img/icon/compare.png"> <span>Compare</span></a></li>
                                <li><a href="#"><img src="/img/icon/search.png"></a><span>Search</span></a></li>
                            </ul>
                        </div>
                        <div class="product__item__text">
                            <h6>${p.Name}</h6>
                            <a href="/Home/SingleProduct/${p.Id}" class="add-cart">View Details</a>
                            <div class="rating">
                                <i class="fa fa-star-o"></i>
                                <i class="fa fa-star-o"></i>
                                <i class="fa fa-star-o"></i>
                                <i class="fa fa-star-o"></i>
                                <i class="fa fa-star-o"></i>
                            </div>
                            <h5>Liên hệ</h5>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            container.innerHTML = `<div class="col-12 text-danger">Lỗi tải sản phẩm: ${e.message}</div>`;
        }
    }

    window.onload = async () => {
        await loadCategories();
        await loadBrands();
        await loadProducts();
    };
</script>
