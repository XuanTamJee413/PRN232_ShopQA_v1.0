@{
    ViewData["Title"] = "Single Product";
    var productId = ViewBag.ProductId;
}
<div id="product-container"></div>

@section Scripts {
    <script>
        let selectedVariantId = null;
        let currentVariant = null;
        let cachedVariants = [];

        const productId = @productId;
        const token = sessionStorage.getItem("JwtToken");

        async function fetchProductDetails(id) {
            try {
                const res = await fetch(`https://localhost:7101/odata/Product(${id})?$expand=Variants,Category,Brand`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Không tìm thấy sản phẩm");
                const json = await res.json();
                renderProduct(json);
            } catch (err) {
                document.getElementById("product-container").innerHTML = `<div class='alert alert-danger'>${err.message}</div>`;
            }
        }

        function renderProduct(data) {
            const variants = data.Variants || [];
            if (variants.length === 0) return;

            cachedVariants = variants;
            currentVariant = variants[0];

            const uniqueSizes = [...new Set(variants.map(v => v.Size))];
            const uniqueColors = [...new Set(variants.map(v => v.Color))];

            const sizeOptions = `<option value="">Chưa chọn</option>` + uniqueSizes.map(s =>
                `<option value="${s}" ${s === currentVariant.Size ? 'selected' : ''}>${s}</option>`
            ).join("");

            const colorOptions = `<option value="">Chưa chọn</option>` + uniqueColors.map(c =>
                `<option value="${c}" ${c === currentVariant.Color ? 'selected' : ''}>${c}</option>`
            ).join("");

            const images = variants.map((v, i) => `
                <li class="nav-item">
                    <a class="nav-link ${i === 0 ? 'active' : ''}" data-toggle="tab" href="#tabs-${i}" onclick="selectImageVariant(${v.Id})">
                        <div class="product__thumb__pic set-bg">
                            <img src="${v.ImageUrl}" onerror="this.src='/img/product/Default_product.jpg';">
                        </div>
                    </a>
                </li>`).join("");

            const tabContent = variants.map((v, i) => `
                <div class="tab-pane ${i === 0 ? 'active' : ''}" id="tabs-${i}">
                    <div class="product__details__pic__item">
                        <img src="${v.ImageUrl}" onerror="this.src='/img/product/Default_product.jpg';" class="img-fluid">
                    </div>
                </div>`).join("");

            document.getElementById("product-container").innerHTML = `
            <div class="product__details__pic">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-3 col-md-3"><ul class="nav nav-tabs">${images}</ul></div>
                        <div class="col-lg-6 col-md-9"><div class="tab-content">${tabContent}</div></div>
                    </div>
                </div>
            </div>
            <div class="product__details__content">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="product__details__text">
                                <h3>${data.Name}</h3>
                                <p>${data.Description || ''}</p>
                                <h5>${data.Brand?.Name || ''}</h5>
                                <h4 id="variantPrice">${currentVariant.Price}₫</h4>
                                <p id="variantStock">Còn hàng: ${currentVariant.Stock} sản phẩm</p>
                                <div class="form-group">
                                    <label for="sizeSelect">Kích thước:</label>
                                    <select id="sizeSelect" class="form-control" onchange="onSizeChange()">${sizeOptions}</select>
                                </div>
                                <div class="form-group">
                                    <label for="colorSelect">Màu sắc:</label>
                                    <select id="colorSelect" class="form-control" onchange="onColorChange()">${colorOptions}</select>
                                </div>
                                <div class="form-group">
                                    <label for="quantity">Số lượng:</label>
                                    <div class="input-group" style="max-width:150px;">
                                        <div class="input-group-prepend"><button class="btn btn-outline-secondary" onclick="adjustQuantity(-1)">-</button></div>
                                        <input type="number" class="form-control text-center" id="quantity" value="1" min="1" onchange="onQuantityInput()" />
                                        <div class="input-group-append"><button class="btn btn-outline-secondary" onclick="adjustQuantity(1)">+</button></div>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="addToCart(${data.Id})">Thêm vào giỏ hàng</button>
                                <div id="cartMessage" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function onSizeChange() {
            const selectedSize = sizeSelect.value;
            const currentColor = colorSelect.value;
            const filteredColors = selectedSize === "" ? [...new Set(cachedVariants.map(v => v.Color))] :
                [...new Set(cachedVariants.filter(v => v.Size === selectedSize).map(v => v.Color))];

            colorSelect.innerHTML = `<option value="">Chưa chọn</option>` +
                filteredColors.map(c => `<option value="${c}">${c}</option>`).join("");
            if (!filteredColors.includes(currentColor)) colorSelect.value = "";
            else colorSelect.value = currentColor;

            updateVariantFromSelect();
        }

        function onColorChange() {
            const selectedColor = colorSelect.value;
            const currentSize = sizeSelect.value;
            const filteredSizes = selectedColor === "" ? [...new Set(cachedVariants.map(v => v.Size))] :
                [...new Set(cachedVariants.filter(v => v.Color === selectedColor).map(v => v.Size))];

            sizeSelect.innerHTML = `<option value="">Chưa chọn</option>` +
                filteredSizes.map(s => `<option value="${s}">${s}</option>`).join("");
            if (!filteredSizes.includes(currentSize)) sizeSelect.value = "";
            else sizeSelect.value = currentSize;

            updateVariantFromSelect();
        }

        function updateVariantFromSelect() {
            const size = sizeSelect.value;
            const color = colorSelect.value;
            const variant = cachedVariants.find(v =>
                (size === "" || v.Size === size) &&
                (color === "" || v.Color === color)
            );
            if (!variant) {
                variantPrice.innerText = "Không tìm thấy biến thể";
                variantStock.innerText = "";
                currentVariant = null;
                return;
            }
            currentVariant = variant;
            selectedVariantId = variant.Id;
            variantPrice.innerText = `${variant.Price}₫`;
            variantStock.innerText = `Kho: ${variant.Stock} sản phẩm`;
            updateQuantityMax();
        }

        function adjustQuantity(change) {
            const input = document.getElementById("quantity");
            let qty = parseInt(input.value || 1);
            qty += change;
            const max = currentVariant?.Stock || 1;
            if (qty < 1) qty = 1;
            if (qty > max) qty = max;
            input.value = qty;
        }

        function onQuantityInput() {
            const input = document.getElementById("quantity");
            const max = currentVariant?.Stock || 1;
            let qty = parseInt(input.value || 1);
            if (qty < 1) qty = 1;
            if (qty > max) qty = max;
            input.value = qty;
        }

        function updateQuantityMax() {
            const input = document.getElementById("quantity");
            const max = currentVariant?.Stock || 1;
            if (parseInt(input.value) > max) input.value = max;
        }

        function selectImageVariant(variantId) {
            const variant = cachedVariants.find(v => v.Id === variantId);
            if (!variant) return;
            currentVariant = variant;
            selectedVariantId = variant.Id;
            sizeSelect.value = variant.Size;
            onSizeChange();
            colorSelect.value = variant.Color;
            variantPrice.innerText = `${variant.Price}₫`;
            variantStock.innerText = `Kho: ${variant.Stock} sản phẩm`;
            updateQuantityMax();
        }

        function addToCart(productId) {
            if (!currentVariant) return showCartMessage("Vui lòng chọn biến thể hợp lệ", true);
            const qty = parseInt(document.getElementById("quantity").value);
            if (qty < 1) return showCartMessage("Số lượng không hợp lệ", true);
            addToCartToApi(currentVariant.Id, qty);
        }

        function showCartMessage(msg, isError = false) {
            const div = document.getElementById("cartMessage");
            div.innerText = msg;
            div.className = `mt-2 alert alert-${isError ? 'danger' : 'success'}`;
            div.style.display = "block";
            setTimeout(() => {
                div.style.display = "none"; 
                div.innerText = "";
            }, 3000);
        }


        async function addToCartToApi(variantId, quantity) {
            const token = sessionStorage.getItem("JwtToken");
            const userJson = sessionStorage.getItem("User");
            const userId = userJson ? JSON.parse(userJson).Id : null;

            if (!userId || !token) return location.replace("/Account/Login");

            const headers = {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            };

            try {
                const cartsRes = await fetch(`https://localhost:7101/odata/Cart?$filter=UserId eq ${userId} and Status eq 'Open'`, { headers });
                let cartId = null;
                if (!cartsRes.ok) throw new Error("Không thể lấy giỏ hàng");

                const openCart = (await cartsRes.json()).value[0];
                if (!openCart) {
                    const res = await fetch("https://localhost:7101/odata/Cart", {
                        method: "POST",
                        headers,
                        body: JSON.stringify({ UserId: userId, CreatedAt: new Date().toISOString(), Status: "Open" })
                    });
                    if (!res.ok) throw new Error("Không tạo được giỏ hàng");
                    cartId = (await res.json()).Id;
                } else cartId = openCart.Id;

                const cartDetailRes = await fetch(`https://localhost:7101/odata/Cart(${cartId})?$expand=Items`, { headers });
                const cartDetail = await cartDetailRes.json();
                const items = cartDetail.Items || [];

                const existingItem = items.find(i => i.ProductVariantId === variantId);
                const currentQty = existingItem ? existingItem.Quantity : 0;

                const productRes = await fetch(`https://localhost:7101/odata/Product(${productId})?$expand=Variants`, { headers });
                const variant = (await productRes.json()).Variants.find(v => v.Id === variantId);
                if (!variant) return showCartMessage("Không tìm thấy biến thể", true);

                const newQty = currentQty + quantity;
                if (newQty > variant.Stock) return showCartMessage("Số lượng trong giỏ hàng vượt quá tồn kho", true);

                if (existingItem) {
                    const res = await fetch(`https://localhost:7101/odata/CartItems(${existingItem.Id})`, {
                        method: "PATCH",
                        headers,
                        body: JSON.stringify({ Quantity: newQty })
                    });
                    if (!res.ok) throw new Error("Cập nhật giỏ hàng thất bại");
                    showCartMessage("Đã cập nhật giỏ hàng");
                } else {
                    const res = await fetch("https://localhost:7101/odata/CartItems", {
                        method: "POST",
                        headers,
                        body: JSON.stringify({
                            CartId: cartId,
                            ProductVariantId: variantId,
                            Quantity: quantity
                        })
                    });
                    if (!res.ok) throw new Error("Không thể thêm sản phẩm");
                    showCartMessage("Đã thêm vào giỏ hàng");
                }
            } catch (err) {
                console.error(err);
                showCartMessage("Lỗi: " + err.message, true);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (!productId || isNaN(productId)) {
                document.getElementById("product-container").innerHTML = '<div class="alert alert-danger">Invalid Product ID</div>';
                return;
            }
            fetchProductDetails(productId);
        });
    </script>
}


<!-- Shop Details Section End -->
<!-- Related Section Begin -->
<!-- Related Section Begin -->
<section class="related spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="related-title">Related Product</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6 col-sm-6">
                <div class="product__item">
                    <div class="product__item__pic set-bg" data-setbg="/img/product/product-1.jpg">
                        <span class="label">New</span>
                        <ul class="product__hover">
                            <li><a href="#"><img src="~/img/icon/heart.png" alt=""></a></li>
                            <li><a href="#"><img src="~/img/icon/compare.png" alt=""> <span>Compare</span></a></li>
                            <li><a href="#"><img src="~/img/icon/search.png" alt=""></a></li>
                        </ul>
                    </div>
                    <div class="product__item__text">
                        <h6>Piqué Biker Jacket</h6>
                        <a href="#" class="add-cart">+ Add To Cart</a>
                        <div class="rating">
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                        </div>
                        <h5>$67.24</h5>
                        <div class="product__color__select">
                            <label for="pc-1">
                                <input type="radio" id="pc-1">
                            </label>
                            <label class="active black" for="pc-2">
                                <input type="radio" id="pc-2">
                            </label>
                            <label class="grey" for="pc-3">
                                <input type="radio" id="pc-3">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 col-sm-6">
                <div class="product__item">
                    <div class="product__item__pic set-bg" data-setbg="/img/product/product-2.jpg">
                        <ul class="product__hover">
                            <li><a href="#"><img src="~/img/icon/heart.png" alt=""></a></li>
                            <li><a href="#"><img src="~/img/icon/compare.png" alt=""> <span>Compare</span></a></li>
                            <li><a href="#"><img src="~/img/icon/search.png" alt=""></a></li>
                        </ul>
                    </div>
                    <div class="product__item__text">
                        <h6>Piqué Biker Jacket</h6>
                        <a href="#" class="add-cart">+ Add To Cart</a>
                        <div class="rating">
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                        </div>
                        <h5>$67.24</h5>
                        <div class="product__color__select">
                            <label for="pc-4">
                                <input type="radio" id="pc-4">
                            </label>
                            <label class="active black" for="pc-5">
                                <input type="radio" id="pc-5">
                            </label>
                            <label class="grey" for="pc-6">
                                <input type="radio" id="pc-6">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 col-sm-6">
                <div class="product__item sale">
                    <div class="product__item__pic set-bg" data-setbg="/img/product/product-3.jpg">
                        <span class="label">Sale</span>
                        <ul class="product__hover">
                            <li><a href="#"><img src="~/img/icon/heart.png" alt=""></a></li>
                            <li><a href="#"><img src="~/img/icon/compare.png" alt=""> <span>Compare</span></a></li>
                            <li><a href="#"><img src="~/img/icon/search.png" alt=""></a></li>
                        </ul>
                    </div>
                    <div class="product__item__text">
                        <h6>Multi-pocket Chest Bag</h6>
                        <a href="#" class="add-cart">+ Add To Cart</a>
                        <div class="rating">
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star"></i>
                            <i class="fa fa-star-o"></i>
                        </div>
                        <h5>$43.48</h5>
                        <div class="product__color__select">
                            <label for="pc-7">
                                <input type="radio" id="pc-7">
                            </label>
                            <label class="active black" for="pc-8">
                                <input type="radio" id="pc-8">
                            </label>
                            <label class="grey" for="pc-9">
                                <input type="radio" id="pc-9">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6 col-sm-6">
                <div class="product__item">
                    <div class="product__item__pic set-bg" data-setbg="/img/product/product-4.jpg">
                        <ul class="product__hover">
                            <li><a href="#"><img src="~/img/icon/heart.png" alt=""></a></li>
                            <li><a href="#"><img src="~/img/icon/compare.png" alt=""> <span>Compare</span></a></li>
                            <li><a href="#"><img src="~/img/icon/search.png" alt=""></a></li>
                        </ul>
                    </div>
                    <div class="product__item__text">
                        <h6>Diagonal Textured Cap</h6>
                        <a href="#" class="add-cart">+ Add To Cart</a>
                        <div class="rating">
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                            <i class="fa fa-star-o"></i>
                        </div>
                        <h5>$60.9</h5>
                        <div class="product__color__select">
                            <label for="pc-10">
                                <input type="radio" id="pc-10">
                            </label>
                            <label class="active black" for="pc-11">
                                <input type="radio" id="pc-11">
                            </label>
                            <label class="grey" for="pc-12">
                                <input type="radio" id="pc-12">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Related Section End -->