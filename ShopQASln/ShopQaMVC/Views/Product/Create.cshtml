<div class="container mt-5">
    <h2 class="mb-4 text-center">Create New Product</h2>

    <form method="post" id="createProductForm" class="border p-4 rounded shadow-sm">
        <div class="mb-3">
            <label for="name" class="form-label">Product Name</label>
            <input type="text" class="form-control" id="name" name="name" placeholder="Enter product name" required />
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" placeholder="Enter product description" rows="3" required></textarea>
        </div>

        <div class="mb-3">
            <label for="price" class="form-label">Price</label>
            <input type="number" class="form-control" id="price" name="price" placeholder="Enter product price" step="0.01" required />
        </div>

        <div class="mb-3">
            <label for="categoryId" class="form-label">Category</label>
            <select class="form-control" id="categoryId" name="categoryId" required>
                <option value="">-- Select category --</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary w-100">Create Product</button>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            // Load categories
            $.ajax({
                url: 'https://localhost:7101/api/Category',
                type: 'GET',
                contentType: 'application/json',
                dataType: 'json',
                success: function (response) {
                    const categorySelect = $('#categoryId');
                    if (Array.isArray(response)) {
                        response.forEach(function (category) {
                            const option = `<option value="${category.id}">${category.name}</option>`;
                            categorySelect.append(option);
                        });
                    } else {
                        console.warn("Category response is not array:", response);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading categories:', xhr.responseText || error);
                    alert('Không thể tải danh mục sản phẩm. Vui lòng thử lại.');
                }
            });

            // Form submit
            $('#createProductForm').submit(function (e) {
                e.preventDefault();

                const name = $('#name').val().trim();
                const description = $('#description').val().trim();
                const price = parseFloat($('#price').val());
                const categoryId = parseInt($('#categoryId').val());

                let errors = [];

                if (name === "") {
                    errors.push("Name is required.");
                } else if (!/^[a-zA-ZÀ-Ỹà-ỹ0-9\s\-]+$/.test(name)) {
                    errors.push("Name must contain only letters, numbers, spaces or hyphens.");
                }

                if (description === "") {
                    errors.push("Description is required.");
                }

                if (isNaN(price) || price <= 0) {
                    errors.push("Price must be a number greater than zero.");
                }

                if (isNaN(categoryId) || categoryId <= 0) {
                    errors.push("Category is required.");
                }

                if (errors.length > 0) {
                    alert(errors.join("\n"));
                    return;
                }

                const productData = {
                    name: name,
                    description: description,
                    price: price,
                    categoryId: categoryId,
                    imageUrl: ""
                };

                $.ajax({
                    url: 'https://localhost:7101/api/Product',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(productData),
                    success: function (response) {
                        alert('Product created successfully!');
                        window.location.href = '/Product/ProductList';
                    },
                    error: function (xhr, status, error) {
                        const errorMessage = xhr.responseText || error;
                        console.error('Error creating product:', errorMessage);
                        alert('Error creating product: ' + errorMessage);
                    }
                });
            });
        });
    </script>
}
